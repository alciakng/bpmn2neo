# Neo4j Graph Schema Documentation

## Overview

This document describes the Neo4j graph database schema generated by `bpmn2neo` when converting BPMN 2.0 XML files to a property graph model. The schema is designed to preserve all BPMN semantics while enabling powerful graph-based queries and analysis.

---

## Node Labels

### 1. Container Nodes

#### `BPMNModel`
Represents a BPMN collaboration or model (top-level container for processes and participants).

**Properties:**
- `id` (string, required): Unique identifier from BPMN XML
- `modelKey` (string, required): Model version/instance key
- `name` (string): Display name of the model
- `containerType` (string): Type of the containing entity (e.g., "Project", "Question")
- `containerId` (string): ID of the containing entity
- Additional attributes from `<collaboration>` element

**Constraints:**
```cypher
CREATE CONSTRAINT bpmn_model_nodekey IF NOT EXISTS
FOR (n:BPMNModel) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

#### `Participant`
Represents a pool in BPMN - an organizational entity or role that executes a process.

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Participant/pool name
- `processRef` (string): Reference to the associated Process
- `containerType` (string): Container type
- `containerId` (string): Container ID
- Additional BPMN attributes

**Constraints:**
```cypher
CREATE CONSTRAINT participant_nodekey IF NOT EXISTS
FOR (n:Participant) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

#### `Process`
Represents a BPMN process - the main executable workflow container.

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Process name
- `containerType` (string): Container type
- `containerId` (string): Container ID
- `processType` (string, optional): "None", "Public", "Private"
- `isClosed` (boolean, optional): Whether the process is closed
- `isExecutable` (boolean, optional): Whether the process is executable
- `definitionalCollaborationRef` (string, optional): Reference to collaboration
- `supports` (string, optional): Support references

**Constraints:**
```cypher
CREATE CONSTRAINT process_nodekey IF NOT EXISTS
FOR (n:Process) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

#### `Lane`
Represents a lane/swimlane within a process - sub-partition of responsibility.

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Lane name
- `containerType` (string): Container type
- `containerId` (string): Container ID
- Additional lane attributes

**Constraints:**
```cypher
CREATE CONSTRAINT lane_nodekey IF NOT EXISTS
FOR (n:Lane) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

### 2. Flow Node Labels

#### `Activity`
Represents all types of BPMN activities (tasks, subprocesses, call activities, etc.).

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Activity name
- `activityType` (string, required): Type of activity
  - `"Task"`: Generic task
  - `"User"`: User task
  - `"Service"`: Service task
  - `"Send"`: Send task
  - `"Receive"`: Receive task
  - `"Manual"`: Manual task
  - `"BusinessRule"`: Business rule task
  - `"Script"`: Script task
  - `"Call"`: Call activity
  - `"SubProcess"`: Subprocess
  - `"Transaction"`: Transaction subprocess
- `containerType` (string): Container type
- `containerId` (string): Container ID
- `isForCompensation` (boolean, optional): Whether activity is for compensation
- `default` (string, optional): Default outgoing flow ID
- `startQuantity` (integer, optional, default: 1): Start quantity
- `completionQuantity` (integer, optional, default: 1): Completion quantity

**Activity Type Specific Properties:**
- **User/Service/BusinessRule Tasks:**
  - `implementation` (string): Implementation type
- **Script Task:**
  - `scriptFormat` (string): Script language format
- **Send/Receive Tasks:**
  - `messageRef` (string): Associated message reference
  - `operationRef` (string): Associated operation reference
- **Receive Task:**
  - `instantiate` (boolean): Whether it instantiates the process
- **Call Activity:**
  - `calledElement` (string): Called process/subprocess ID
- **SubProcess:**
  - `triggeredByEvent` (boolean): Whether it's an event subprocess
- **Transaction:**
  - `method` (string, default: "##Compensate"): Transaction method

**Loop Characteristics:**
- `hasStandardLoop` (boolean): Has standard loop characteristics
- `standardLoopTestBefore` (boolean): Test condition before execution
- `standardLoopMaximum` (integer): Maximum loop iterations
- `hasMultiInstance` (boolean): Has multi-instance characteristics
- `multiInstanceSequential` (boolean): Sequential multi-instance
- `multiInstanceBehavior` (string): Behavior ("All", "One", "Complex")

**Constraints:**
```cypher
CREATE CONSTRAINT activity_nodekey IF NOT EXISTS
FOR (n:Activity) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

#### `Event`
Represents all types of BPMN events (start, end, intermediate, boundary).

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Event name
- `position` (string, required): Event position
  - `"Start"`: Start event
  - `"End"`: End event
  - `"Intermediate"`: Intermediate catch/throw event
  - `"Boundary"`: Boundary event
- `detailType` (string, required): Event definition type
  - `"None"`: None/empty event
  - `"Message"`: Message event
  - `"Timer"`: Timer event
  - `"Error"`: Error event
  - `"Escalation"`: Escalation event
  - `"Conditional"`: Conditional event
  - `"Link"`: Link event
  - `"Compensate"`: Compensation event
  - `"Signal"`: Signal event
  - `"Terminate"`: Terminate event
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Position-Specific Properties:**
- **Start Events:**
  - `isInterrupting` (boolean, default: true): Whether event interrupts
  - `parallelMultiple` (boolean): Parallel multiple event
- **Boundary Events:**
  - `attachedToRef` (string): Activity this event is attached to
  - `cancelActivity` (boolean, default: true): Whether it cancels the activity
- **Intermediate Events:**
  - `parallelMultiple` (boolean): Parallel multiple event

**Link Events:**
- `linkName` (string): Name of the link connection
- `isForCompensation` (boolean): For compensation boundary events

**Multiple Event Definitions:**
- `eventDefinitionCount` (integer): Number of event definitions
- `eventDefinitionTypes` (list): List of definition type names

**Constraints:**
```cypher
CREATE CONSTRAINT event_nodekey IF NOT EXISTS
FOR (n:Event) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

#### `Gateway`
Represents all types of BPMN gateways (decision/merge points).

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Gateway name
- `gatewayType` (string, required): Type of gateway
  - `"Exclusive"`: Exclusive (XOR) gateway
  - `"Parallel"`: Parallel (AND) gateway
  - `"Inclusive"`: Inclusive (OR) gateway
  - `"Complex"`: Complex gateway
  - `"EventBased"`: Event-based gateway
- `containerType` (string): Container type
- `containerId` (string): Container ID
- `gatewayDirection` (string, optional, default: "Unspecified"): Direction
  - `"Diverging"`: Split
  - `"Converging"`: Join
  - `"Mixed"`: Both
  - `"Unspecified"`: Not specified
- `default` (string, optional): Default flow ID (for Exclusive/Inclusive/Complex)
- `defaultFlow` (string, optional): Alias for default flow

**Event-Based Gateway:**
- `eventGatewayType` (string, default: "Exclusive"): Gateway sub-type
- `instantiate` (boolean): Whether gateway instantiates process

**Constraints:**
```cypher
CREATE CONSTRAINT gateway_nodekey IF NOT EXISTS
FOR (n:Gateway) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

### 3. Data Elements

#### `Data`
Represents BPMN data objects and data stores (definitions).

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Data element name
- `dataType` (string, required): Type of data element
  - `"Object"`: Data object definition
  - `"Store"`: Data store definition
- `containerType` (string): Container type
- `containerId` (string): Container ID
- `itemSubjectRef` (string, optional): Reference to data type definition
- `isCollection` (boolean, optional): Whether it's a collection

**Data Store Specific:**
- `capacity` (integer, optional): Store capacity
- `isUnlimited` (boolean, optional): Whether capacity is unlimited

**Constraints:**
```cypher
CREATE CONSTRAINT data_nodekey IF NOT EXISTS
FOR (n:Data) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

#### `DataReference`
Represents references to data objects/stores within a process (instances).

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, required): Model version/instance key
- `name` (string): Reference name
- `dataType` (string, required): Type of reference
  - `"ObjectReference"`: Data object reference
  - `"StoreReference"`: Data store reference
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Object Reference Specific:**
- `dataObjectRef` (string): ID of the referenced Data node
- `dataState` (string, optional): State of the data

**Store Reference Specific:**
- `dataStoreRef` (string): ID of the referenced Data node

**Constraints:**
```cypher
CREATE CONSTRAINT dataref_nodekey IF NOT EXISTS
FOR (n:DataReference) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

### 4. Annotation Elements

#### `TextAnnotation`
Represents BPMN text annotations (documentation/comments).

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, optional): Model version/instance key (inherited from neighbors)
- `name` (string): Truncated text content (first 80 chars)
- `text` (string): Full annotation text content
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Constraints:**
```cypher
CREATE CONSTRAINT textanno_nodekey IF NOT EXISTS
FOR (n:TextAnnotation) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

#### `Group` (or `GROUP`)
Represents BPMN groups (visual grouping of elements).

**Properties:**
- `id` (string, required): Unique identifier
- `modelKey` (string, optional): Model version/instance key (inherited from neighbors)
- `name` (string): Group name
- `containerType` (string): Container type
- `containerId` (string): Container ID
- `categoryValueRef` (string, optional): Reference to category value
- `categoryValue` (string, optional): Resolved category value text

**Constraints:**
```cypher
CREATE CONSTRAINT group_nodekey IF NOT EXISTS
FOR (n:GROUP) REQUIRE (n.id, n.modelKey) IS NODE KEY
```

---

## Relationship Types

### 1. Structural Hierarchy

#### `HAS_MODEL`
Connects a container to its BPMN models.

**Pattern:**
```cypher
(Container)-[:HAS_MODEL]->(BPMNModel)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

#### `HAS_PARTICIPANT`
Connects a BPMN model to its participants (pools).

**Pattern:**
```cypher
(BPMNModel)-[:HAS_PARTICIPANT]->(Participant)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

#### `EXECUTES`
Connects a participant to the process it executes.

**Pattern:**
```cypher
(Participant)-[:EXECUTES]->(Process)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

#### `HAS_LANE`
Connects a process to its lanes.

**Pattern:**
```cypher
(Process)-[:HAS_LANE]->(Lane)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

#### `OWNS_NODE`
Defines ownership of flow nodes by process or lane.

**Pattern:**
```cypher
(Process|Lane)-[:OWNS_NODE]->(Activity|Event|Gateway)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Logic:**
- If a process has lanes: Flow nodes are owned by their respective lanes
- If a process has no lanes: All flow nodes are owned by the process
- Unassigned nodes in a lane-based process: Owned by the process

---

#### `CONTAINS`
Defines containment of flow nodes within subprocesses.

**Pattern:**
```cypher
(Activity:SubProcess)-[:CONTAINS]->(Activity|Event|Gateway)
```

**Properties:**
- `connectionType` (string): Always `"containment"`
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Note:** Used for SubProcess, Transaction, and AdHocSubProcess activities.

---

### 2. Flow Relationships

#### `SEQUENCE_FLOW`
Represents control flow between flow nodes within a process.

**Pattern:**
```cypher
(FlowNode)-[:SEQUENCE_FLOW]->(FlowNode)
```

**Properties:**
- `id` (string): Sequence flow ID
- `flowName` (string): Name or ID of the flow
- `flowType` (string): Type of sequence flow
  - `"SequenceFlow"`: Normal sequence flow
  - `"ConditionalSequenceFlow"`: Conditional flow
- `isDefault` (boolean): Whether this is a default flow from a gateway
- `condition` (string, optional): Conditional expression (for conditional flows)
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

#### `MESSAGE_FLOW`
Represents message exchange between participants (across pools).

**Pattern:**
```cypher
(Participant|Activity|Event)-[:MESSAGE_FLOW]->(Participant|Activity|Event)
```

**Properties:**
- `id` (string): Message flow ID
- `flowName` (string): Name or ID of the flow
- `flowType` (string): Always `"MessageFlow"`
- `messageRef` (string, optional): Reference to message definition
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

#### `LINK_TO`
Connects link throw events to link catch events (same link name).

**Pattern:**
```cypher
(Event:Throw)-[:LINK_TO]->(Event:Catch)
```

**Properties:**
- `linkName` (string): Name of the link connection
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Note:** Links multiple throw events to multiple catch events with the same linkName within the same scope.

---

### 3. Activity Relationships

#### `HAS_BOUNDARY_EVENT`
Connects an activity to its attached boundary events.

**Pattern:**
```cypher
(Activity)-[:HAS_BOUNDARY_EVENT]->(Event:Boundary)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

#### `CALLS_PROCESS`
Represents a call activity invoking another process.

**Pattern:**
```cypher
(Activity:Call)-[:CALLS_PROCESS]->(Process)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Note:** Links to the process ID specified in the `calledElement` attribute.

---

#### `COMPENSATES`
Represents compensation relationship from a compensation event to an activity.

**Pattern:**
```cypher
(Event:Compensate)-[:COMPENSATES]->(Activity)
```

**Properties:**
- `compensationType` (string): Always `"specific"`
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

---

### 4. Data Flow Relationships

#### `REFERS_TO`
Connects a data reference to its data definition.

**Pattern:**
```cypher
(DataReference)-[:REFERS_TO]->(Data)
```

**Properties:**
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID

**Logic:**
- `DataReference:ObjectReference` → `Data:Object` (via `dataObjectRef`)
- `DataReference:StoreReference` → `Data:Store` (via `dataStoreRef`)

---

#### `READS_FROM`
Represents data input association (activity reads from data).

**Pattern:**
```cypher
(Activity)-[:READS_FROM]->(Data|DataReference)
```

**Properties:**
- `associationType` (string): Always `"input"`
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID
- Additional attributes from `<dataInputAssociation>` element

---

#### `WRITES_TO`
Represents data output association (activity writes to data).

**Pattern:**
```cypher
(Activity)-[:WRITES_TO]->(Data|DataReference)
```

**Properties:**
- `associationType` (string): Always `"output"`
- `modelKey` (string): Model version/instance key
- `containerType` (string): Container type
- `containerId` (string): Container ID
- Additional attributes from `<dataOutputAssociation>` element

---

### 5. Annotation Relationships

#### `ANNOTATES`
Connects a text annotation to the element it documents.

**Pattern:**
```cypher
(TextAnnotation)-[:ANNOTATES]->(Any BPMN Element)
```

**Properties:**
- `modelKey` (string): Model version/instance key (inherited from either node)
- `containerType` (string): Container type
- `containerId` (string): Container ID
- Additional attributes from `<association>` element

**Note:** Direction is always from annotation to the annotated element.

---

#### `GROUPS`
Connects a group to the elements it visually groups.

**Pattern:**
```cypher
(Group)-[:GROUPS]->(Any BPMN Element)
```

**Properties:**
- `modelKey` (string): Model version/instance key (inherited from either node)
- `containerType` (string): Container type
- `containerId` (string): Container ID
- Additional attributes from `<association>` element

---

## Common Property Patterns

All nodes and relationships include these common properties for multi-tenancy and versioning:

- `containerType` (string): Type of the container (e.g., "Project", "Question")
- `containerId` (string): Unique identifier of the container
- `modelKey` (string): Version/instance key for the BPMN model

These properties enable:
1. **Multi-tenancy**: Isolate data by container
2. **Versioning**: Track different versions of the same model
3. **Cleanup**: Efficiently delete all data for a specific model/container

---

## Schema Constraints

The schema uses composite node key constraints to ensure uniqueness and improve query performance:

```cypher
// Node key constraints (id + modelKey)
CREATE CONSTRAINT bpmn_model_nodekey IF NOT EXISTS
FOR (n:BPMNModel) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT participant_nodekey IF NOT EXISTS
FOR (n:Participant) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT process_nodekey IF NOT EXISTS
FOR (n:Process) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT lane_nodekey IF NOT EXISTS
FOR (n:Lane) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT activity_nodekey IF NOT EXISTS
FOR (n:Activity) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT event_nodekey IF NOT EXISTS
FOR (n:Event) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT gateway_nodekey IF NOT EXISTS
FOR (n:Gateway) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT data_nodekey IF NOT EXISTS
FOR (n:Data) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT dataref_nodekey IF NOT EXISTS
FOR (n:DataReference) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT group_nodekey IF NOT EXISTS
FOR (n:GROUP) REQUIRE (n.id, n.modelKey) IS NODE KEY;

CREATE CONSTRAINT textanno_nodekey IF NOT EXISTS
FOR (n:TextAnnotation) REQUIRE (n.id, n.modelKey) IS NODE KEY;
```

**Benefits:**
- Ensures uniqueness of (id, modelKey) pairs
- Automatically creates indexes for faster lookups
- Enables efficient MERGE operations during loading

---

## Example Queries

### Find all activities in a specific process
```cypher
MATCH (p:Process {id: 'Process_1', modelKey: 'v1.0'})-[:OWNS_NODE]->(a:Activity)
RETURN a.name, a.activityType
```

### Trace sequence flow from start to end
```cypher
MATCH path = (start:Event {position: 'Start', modelKey: 'v1.0'})-[:SEQUENCE_FLOW*]->(end:Event {position: 'End'})
WHERE start.modelKey = end.modelKey
RETURN path
```

### Find all message flows between participants
```cypher
MATCH (p1:Participant)-[:MESSAGE_FLOW]->(p2:Participant)
WHERE p1.modelKey = 'v1.0'
RETURN p1.name, p2.name
```

### Find all data written by a specific activity
```cypher
MATCH (a:Activity {id: 'Activity_1', modelKey: 'v1.0'})-[:WRITES_TO]->(d)
RETURN d.name, d.dataType
```

### Find all boundary events on an activity
```cypher
MATCH (a:Activity {id: 'Activity_1', modelKey: 'v1.0'})-[:HAS_BOUNDARY_EVENT]->(e:Event)
RETURN e.name, e.detailType
```

### Clean up a specific model
```cypher
// Delete all relationships for a model
MATCH ()-[r]-() WHERE r.modelKey = 'v1.0' DELETE r;

// Delete all nodes for a model
MATCH (n) WHERE n.modelKey = 'v1.0' DETACH DELETE n;
```

---

## Data Loading Process

The `bpmn2neo` loader follows this sequence:

1. **Parse BPMN XML** → Extract nodes and relationships
2. **Cleanup** → Remove existing data for the same modelKey (optional)
3. **Ensure Schema** → Create constraints if they don't exist
4. **Load Nodes** → Batch insert all nodes using MERGE
5. **Load Relationships** → Batch insert all relationships
6. **Verify** → Log statistics and validate loading

---

## Design Principles

1. **Semantic Fidelity**: All BPMN 2.0 semantics are preserved
2. **Graph-Native**: Leverages Neo4j's relationship traversal capabilities
3. **Multi-Tenancy**: Container and model keys enable isolation
4. **Query Performance**: Composite constraints and strategic indexing
5. **Extensibility**: Additional properties can be added without schema changes
6. **BPMN Standard Compliance**: Follows OMG BPMN 2.0 specification

---

## Version History

- **v1.0**: Initial schema design with comprehensive BPMN 2.0 support

---

## References

- [BPMN 2.0 Specification](https://www.omg.org/spec/BPMN/2.0/)
- [Neo4j Cypher Manual](https://neo4j.com/docs/cypher-manual/)
- [bpmn2neo GitHub Repository](https://github.com/alciakng/bpmn2neo)
